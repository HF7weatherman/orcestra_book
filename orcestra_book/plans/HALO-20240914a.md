---
arrival_airport: TBPB
categories: [ec_under, ec_track, c_north, c_mid, c_south]
crew:
- job: PI
  name: "Helene Gl\xF6ckner"
- job: WALES
  name: Georgios Dekoutsidis
- job: HAMP
  name: Clara Bayley
- job: Dropsondes
  name: Theresa Mieslinger
- job: Smart/VELOX
  name: null
- job: SpecMACS
  name: null
- job: Flight Documentation
  name: Lukas Kluft
- job: Ground contact
  name: null
departure_airport: TBPB
flight_id: HALO-20240914a
jupytext:
  text_representation:
    extension: .md
    format_name: myst
kernelspec:
  display_name: Python 3 (ipykernel)
  language: python
  name: python3
landing: '2024-09-14 20:55:00Z'
orphan: true
platform: HALO
takeoff: '2024-09-14 20:55:00Z'
---

{logo}`PERCUSION`

# Flight plan - {front}`flight_id`

```{badges}
```

## Crew

The flight is planned to take off at {front}`takeoff`.

```{crew}
```

## Flight plan

```{code-cell} ipython3
:tags: [hide-input]

from dataclasses import asdict
from datetime import datetime
import orcestra.sat
from orcestra.flightplan import bco, sal, mindelo, point_on_track, LatLon, IntoCircle, FlightPlan


# Some fixed coordinates

lon_min, lon_max, lat_min, lat_max = -65, -5, -5, 25

airport = bco

radius = 72e3*1.852

# Define dates for flight

flight_time   = datetime(2024, 9, 14, 12, 0, 0)
flight_index = f"HALO-{flight_time.strftime('%Y%m%d')}a"

# Load satellite tracks 

ec_fcst_time  = "2024-09-09"
ec_track = orcestra.sat.SattrackLoader("EARTHCARE", ec_fcst_time, kind="PRE",roi="BARBADOS") \
    .get_track_for_day(f"{flight_time:%Y-%m-%d}")\
    .sel(time=slice(f"{flight_time:%Y-%m-%d} 14:00", None))

# Create elements of track
ec_south =  point_on_track(ec_track,lat=  5.0).assign(label = "ec_south")

# circle centers
c_south  = point_on_track(ec_track,lat=  7.50).assign(label = "c_south")
c_mid    = point_on_track(ec_track,lat= 10.25).assign(label = "c_mid")
c_south2  = c_south.towards(c_mid, distance=radius).assign(label="c_south2")
c_north  = point_on_track(ec_track,lat= 13.00).assign(label = "c_north")
#circle in / out (not necessary but nice to have for more waypoints
cn_out    = c_north.towards(c_mid,distance=radius).assign(label = "c_out")
cm_out = c_mid.towards(c_south, distance=radius).assign(label="c_out")
cs2_out = c_south2.towards(c_south, distance=radius).assign(label="c_out")
cs_out = c_south.towards(c_mid, distance=radius).assign(label="c_out")
# earthcare end points 
ec_north = c_north.towards(c_mid, distance=radius).assign(label = "ec_north") 

c_wait   = c_south.towards(c_mid, distance=radius*0.5).assign(label = "c_wait")
cw_out = c_south.towards(c_mid, distance=radius).assign(label = "c_out")

# intersection
int_ss1, int_ss2 = IntoCircle(c_south, radius, 360).get_intersect(IntoCircle(c_south2, radius, 360))
int_sm1, int_sm2 = IntoCircle(c_south2, radius, 360).get_intersect(IntoCircle(c_mid, radius, 360))

xlat     = c_mid.towards(cn_out, fraction=1/6).lat
ec_under = point_on_track(ec_track, lat=xlat, with_time=True).assign(label = "ec_under", note = "meet EarthCARE")

# Additional Waypoints

extra_waypoints = []

# Define Flight Paths

waypoints = [
    airport.assign(fl=0),
    ec_south.assign(fl=410),
    int_ss1.assign(fl=410, label="inter"),
    IntoCircle(c_south.assign(fl=410), radius, angle=-360),
    cw_out.assign(fl=430),
    IntoCircle(c_wait.assign(fl=430), radius*0.5, angle=360),
    int_ss2.assign(fl=430, label="inter"),
    IntoCircle(c_south2.assign(fl=430, label='c_south2'), radius, 360), 
    int_sm2.assign(fl=450, label="inter"),
    IntoCircle(c_mid.assign(fl=450), radius, 360), 
    cm_out.assign(fl=450),
    ec_under.assign(fl=450),
    IntoCircle(c_north.assign(fl=450), radius, angle=360), 
    cn_out.assign(fl=450),
    airport.assign(fl=0),
]

# Crew

crew = {
    'Mission PI': 'Helene Glöckner',
    'DropSondes': 'Theresa Mieslinger',
    'HAMP': 'Clara Bayley',
    'SMART/VELOX': '',
    'SpecMACS': '',
    'WALES' : '',
    'Flight Documentation': 'Lukas Kluft',
    'Ground Support': ''
}

# Plan

plan = FlightPlan(waypoints, flight_index, extra_waypoints=extra_waypoints, crew=crew, aircraft="HALO")
print(f"Flight index: {plan.flight_id}")
print(f"Take-off: {plan.takeoff_time:%H:%M %Z}\nLanding:  {plan.landing_time:%H:%M %Z}\n")

print(plan.landing_time - plan.takeoff_time)
```

```{code-cell} ipython3
:tags: [hide-input]

import matplotlib.pyplot as plt
import cartopy.crs as ccrs
import easygems.healpix as egh
import intake
from orcestra.flightplan import plot_cwv, plot_path
import topojson
import json

forecast_overlay=True

plt.figure(figsize = (14, 8))
ax = plt.axes(projection=ccrs.PlateCarree())
ax.set_extent([lon_min, lon_max, lat_min, lat_max], crs=ccrs.PlateCarree())
ax.coastlines(alpha=1.0)
ax.gridlines(draw_labels=True, dms=True, x_inline=False, y_inline=False, alpha = 0.25)

if (forecast_overlay):
    ifs_fcst_time = datetime(2024, 9, 9, 0, 0, 0)
    ds = intake.open_catalog("https://tcodata.mpimet.mpg.de/internal.yaml").HIFS(datetime = ifs_fcst_time).to_dask().pipe(egh.attach_coords)
    cwv_flight_time = ds["tcwv"].sel(time=flight_time, method = "nearest")
    plot_cwv(cwv_flight_time, levels = [48.0, 50.0,55.0, 60.0], ax=ax)
    plt.title(f"{flight_time}\n(CWV forecast issued on {ifs_fcst_time})")

plt.plot(ec_track.lon, ec_track.lat, c='k', ls='dotted')
plot_path(plan, ax, color="C1")

with open("worldfirs.json", 'r') as f:
    data = json.load(f)
# parse topojson file using `object_name`
topo = topojson.Topology(data, object_name="data")
firs = topo.to_gdf()
for i, row in firs.iterrows():
    for geom in getattr(row.geometry.boundary, "geoms", [row.geometry.boundary]):
        lon, lat = zip(*list(geom.coords))
        ax.plot(lon, lat, transform=ccrs.PlateCarree(), color='k', lw=1)
forecast_overlay = True


#plt.scatter(int_circ1.lon, int_circ1.lat, c='k')
#plt.scatter(int_circ2.lon, int_circ2.lat, c='k')
```

```{code-cell} ipython3
:tags: [hide-input]

from orcestra.flightplan import vertical_preview

vertical_preview(waypoints)
```

```{code-cell} ipython3
:tags: [hide-input]

plan.show_details()
plan.export()
```

```{code-cell} ipython3
:tags: [hide-input]

print(ec_south.lat, ec_south.lon)
```

```{code-cell} ipython3
:tags: [hide-input]
#option 2: two center circles 

from dataclasses import asdict
from datetime import datetime
import orcestra.sat
from orcestra.flightplan import bco, sal, mindelo, point_on_track, LatLon, IntoCircle, FlightPlan


#fun alternative
# Some fixed coordinates

lon_min, lon_max, lat_min, lat_max = -65, -5, -5, 25

airport = bco

radius = 72e3*1.852

# Define dates for flight

flight_time   = datetime(2024, 9, 14, 12, 0, 0)
flight_index = f"HALO-{flight_time.strftime('%Y%m%d')}a"

# Load satellite tracks 

ec_fcst_time  = "2024-09-09"
ec_track = orcestra.sat.SattrackLoader("EARTHCARE", ec_fcst_time, kind="PRE",roi="BARBADOS") \
    .get_track_for_day(f"{flight_time:%Y-%m-%d}")\
    .sel(time=slice(f"{flight_time:%Y-%m-%d} 14:00", None))

# Create elements of track
ec_south =  point_on_track(ec_track,lat=  5.0).assign(label = "ec_south")

# circle centers

c_mid_on_track    = point_on_track(ec_track,lat= 10.25).assign(label = "c_mid")
c_south  = point_on_track(ec_track,lat=  7.50).assign(label = "c_south")
cm_out    = point_on_track(ec_track,lat= 10.25).assign(label = "cm_out")
c_mid = c_mid_on_track.course(direction=-90, distance=radius).assign(label="c_mid")
c_mid2  = c_mid_on_track.course(direction=90, distance=radius).assign(label="c_mid")
c_north  = point_on_track(ec_track,lat= 13.00).assign(label = "c_north")
#circle in / out (not necessary but nice to have for more waypoints
cn_out    = c_north.towards(cm_out, distance=radius).assign(label = "c_out")
cs_out = c_south.towards(cm_out, distance=-radius).assign(label="c_out")
# earthcare end points 
#ec_south =  c_south.towards(c_mid, distance=radius).assign(label="ec_south")
ec_north = c_north.towards(cm_out, distance=radius).assign(label = "ec_north") 

#c_wait   = c_south.towards(c_mid, distance=radius*0.5).assign(label = "c_wait")

#xlat     = c_south.towards(c_mid,distance=-radius).lat
#x_lat = 5.0
#ec_south = point_on_track(ec_track,lat=  xlat).assign(label = "ec_south")

xlat     = cs_out.towards(cm_out, fraction=1/2).lat
ec_under = point_on_track(ec_track, lat=xlat, with_time=True).assign(label = "ec_under", note = "meet EarthCARE")

# Additional Waypoints

extra_waypoints = []

# Define Flight Paths

waypoints = [
    airport.assign(fl=0),
    ec_south.assign(fl=410),
    IntoCircle(c_south.assign(fl=410), radius, angle=-360),
    cs_out.assign(fl=410),
#    IntoCircle(c_wait.assign(fl=430), radius*0.5, angle=360),
#    IntoCircle(c_south2.assign(fl=430, label='c_south2'), radius, 360), 
 #   cs2_out.assign(fl=430),
    ec_under.assign(fl=430),
    cm_out.assign(fl=430),
    IntoCircle(c_mid.assign(fl=430), radius, -360), 
    cm_out.assign(fl=450),
    IntoCircle(c_mid2.assign(fl=450), radius, -360), 
    cm_out.assign(fl=450),
    IntoCircle(c_north.assign(fl=450), radius, angle=-360), 
    cn_out.assign(fl=450),
    airport.assign(fl=0),
]

# Crew

crew = {
    'Mission PI': 'Helene Glöckner',
    'DropSondes': 'Theresa Mieslinger',
    'HAMP': 'Clara Bayley',
    'SMART/VELOX': '',
    'SpecMACS': '',
    'WALES' : '',
    'Flight Documentation': 'Lukas Kluft',
    'Ground Support': ''
}

# Plan

plan = FlightPlan(waypoints, flight_index, extra_waypoints=extra_waypoints, crew=crew, aircraft="HALO")
print(f"Flight index: {plan.flight_id}")
print(f"Take-off: {plan.takeoff_time:%H:%M %Z}\nLanding:  {plan.landing_time:%H:%M %Z}\n")

print(plan.landing_time - plan.takeoff_time)
```

```{code-cell} ipython3
:tags: [hide-input]

import matplotlib.pyplot as plt
import cartopy.crs as ccrs
import easygems.healpix as egh
import intake
from orcestra.flightplan import plot_cwv, plot_path

forecast_overlay = True


plt.figure(figsize = (14, 8))
ax = plt.axes(projection=ccrs.PlateCarree())
ax.set_extent([lon_min, lon_max, lat_min, lat_max], crs=ccrs.PlateCarree())
ax.coastlines(alpha=1.0)
ax.gridlines(draw_labels=True, dms=True, x_inline=False, y_inline=False, alpha = 0.25)

if (forecast_overlay):
    ifs_fcst_time = datetime(2024, 9, 9, 0, 0, 0)
    ds = intake.open_catalog("https://tcodata.mpimet.mpg.de/internal.yaml").HIFS(datetime = ifs_fcst_time).to_dask().pipe(egh.attach_coords)
    cwv_flight_time = ds["tcwv"].sel(time=flight_time, method = "nearest")
    plot_cwv(cwv_flight_time, levels = [48.0, 50.0,55.0, 60.0], ax=ax)
    plt.title(f"{flight_time}\n(CWV forecast issued on {ifs_fcst_time})")

plt.plot(ec_track.lon, ec_track.lat, c='k', ls='dotted')
plot_path(plan, ax, color="C1")
```

```{code-cell} ipython3
:tags: [hide-input]

plan.show_details()
plan.export()
```
